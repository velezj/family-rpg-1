<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="dm-style.css"/>
  </head>
  <body>

    <div class="whole">

      <div class="name">{{ name | e }}</div>
      
      <div class="sheet">

	<!-- the bio that is "computable" -->
	<div class="character-structured-bio">
	  <h1>Bio Data</h1>
	  <span class="name">{{ name | e }}</span>
	  {%- for at in attribs -%}
	    {%- if at.name in ["class", "race", "level"] -%}
	      <div>{{ at.name | lower | e }}:
		<span class="bio-{{ at.name | lower | e }}"> {{ at.current | e }} </span>
	      </div>
	    {%- endif -%}
	  {%- endfor -%}
	</div>



	<!-- core ability scores -->
	<div class="core-ability-scores">
	  <h1>Core Ability Scores</h1>
	  {%- for at in attribs -%}
	    {%- if at.name in ["strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma"] -%}
	      <div>{{ at.name | lower | e }}:
		<span class="ability-{{ at.name[:3] | lower | e }}"> {{ at.current | e }} </span>
	      </div>
	    {%- endif -%}
	  {%- endfor -%}
	</div>
	
	
	<!-- saving throws -->
	<div class="saving-throws">
	  <h1>Saving Throws</h1>
	  {%- for at in attribs -%}
	    {%- if at.name.endswith("save_bonus") -%}
	      <div>{{ at.name[:-11] | lower | e }}:
		<span class="saving-throw-{{ at.name[:-11] | lower | e }}"> {{ at.current | e }} </span>
	      </div>
	    {%- endif -%}
	  {%- endfor -%}    
	</div>
	
	
	<!-- skill checks -->
	<div class="skill-checks">
	  <h1>Skill Checks</h1>
	  {%- for at in attribs -%}
	    {%- if at.name.endswith("_bonus") and not at.name.endswith("_save_bonus") -%}
	      {%- if at.name[:-6] in ["athletics","acrobatics","sleight_of_hand","stealth","arcana","history","investigation","nature","religion","animal_handling","insight","medicine","perception","survival","deception","intimidation","performance","persuasion"] -%}
		<div>{{ at.name[:-6].replace("_"," ") | lower | e }}:
		  <span class="saving-throw-{{ at.name[:-6] | lower | e }}"> {{ at.current | e }} </span>
		</div>
	      {%- endif -%}
	    {%- endif -%}
	  {%- endfor -%}    
	</div>
	
	
	<!-- inspiration, proficency and passive perception -->
	<div class="misc-scores">
	  <h1>Misc. Scores</h1>
	  {%- for at in attribs -%}
	    {%- if at.name in ["inspiration","proficiency","passive_perception"] -%}
	      <div>{{ at.name | e}}:
		<div name="score-{{ at.name | e }}">
		  {{ at.current | e }}
		</div>
	      </div>
	    {%- endif -%}
	  {%- endfor -%}
	</div>

	
	<!-- fight sections -->
	<div class="fight-section">
	  <h1>Fight Section</h1>
	  {%- for at in attribs -%}
	    {%- if at.name in ["ac","speed","hp"] -%}
	      <div>{{ at.name[:2] | e }}:
		<span name="fight-{{ at.name | e }}">
		  {{ at.current | e }}
		</span>
	      </div>
	    {%- endif -%}
	  {%- endfor -%}
	  {%- for at in attribs -%}
	    {%- if at.name in ["initiative_bonus"] -%}
	      <div>Init:
		<span name="fight-{{ at.name[:-6] | e }}">
		  {{ at.current | e }}
		</span>
	      </div>
	    {%- endif -%}
	  {%- endfor -%}
	</div>

	<!-- structured background -->
	<div class="structured-background-section">
	  <h1>Structured Background</h1>

	  <!-- personality and personal elements -->
	  {%- for at in attribs -%}
	    {%- if at.name in ["personality_traits","ideals","bonds","flaws"] -%}
	      <div>{{ at.name | e }}:
		<div name="structured-background-{{ at.name | e }}">
		  {{ at.current | e }}
		</div>
	      </div>
	    {%- endif -%}
	  {%- endfor -%}
	</div>


	<!-- traits from classes and races -->
	<div class="features-and-traits">
	  <h1>Features and Traits</h1>
	  {%- set traitmap = dict() -%}
	  {%- do traitmap.clear() -%}
	  {%- for at in attribs -%}
	    {%- if at.name.startswith("repeating_traits_") -%}
	      {%- set kvtemp = at.name[17:] -%}
	      {%- set pivot = kvtemp.find("_") -%}
	      {%- set key = kvtemp[:pivot] -%}
	      {%- set value = kvtemp[pivot+1:] -%}
	      {%- if key not in traitmap -%}
		{%- do traitmap.update({ key: dict() }) -%}
	      {%- endif -%}
	      {%- do traitmap[key].update({ value : at.current}) -%}
	    {%- endif -%}
	  {%- endfor -%}
	  {%- for trait in traitmap -%}
	    <div class="trait-{{ traitmap[trait].name | e }}">
	      <h3>{{ traitmap[trait].name | e }}</h3>
	      {%- for kv in traitmap[trait].items() -%}
		{%- if kv[0] in ["description"] -%}
		  <p>{{ kv[1] | e }}</p>
		{%- endif -%}
	      {%- endfor -%}
	    </div>
	  {%- endfor -%}
	</div>


	<!-- proficiency -->
	<div class="proficiencies">
	  <h1>Proficiencies</h1>
	  {%- set traitmap = dict() -%}
	  {%- do traitmap.clear() -%}
	  {%- for at in attribs -%}
	    {%- if at.name.startswith("repeating_proficiencies_") -%}
	      {%- set toks = at.name.split("_") -%}
	      {%- set key = toks[2] -%}
	      {%- set value = "_".join( toks[3:] ) -%}
	      {%- if key not in traitmap -%}
		{%- do traitmap.update({ key: dict() }) -%}
	      {%- endif -%}
	      {%- do traitmap[key].update({ value : at.current}) -%}
	    {%- endif -%}
	  {%- endfor -%}
	  {%- for trait in traitmap -%}
	    <div class="proficiency-{{ traitmap[trait].name | e }}">
	      <h3>{{ traitmap[trait].name | e }}</h3>
	      <ul>
		{%- for kv in traitmap[trait].items() -%}
		  <li>{{ kv[0] | e }} = {{ kv[1] | e }}</li>
		{%- endfor -%}
	      </ul>
	    </div>
	  {%- endfor -%}
	</div>


	<!-- items -->
	<div class="items">
	  <h1>Items</h1>
	  {%- set traitmap = dict() -%}
	  {%- do traitmap.clear() -%}
	  {%- for at in attribs -%}
	    {%- if at.name.startswith("repeating_inventory_") -%}
	      {%- set toks = at.name.split("_") -%}
	      {%- set key = toks[2] -%}
	      {%- set value = "_".join( toks[3:] ) -%}
	      {%- if key not in traitmap -%}
		{%- do traitmap.update({ key: dict() }) -%}
	      {%- endif -%}
	      {%- do traitmap[key].update({ value : at.current}) -%}
	    {%- endif -%}
	  {%- endfor -%}
	  {%- for trait in traitmap -%}
	    <div class="item-{{ traitmap[trait].itemname | e }}">
	      <h3>{{ traitmap[trait].itemname | e }}</h3>
	      {# <ul> #}
	      {# 	{%- for kv in traitmap[trait].items() -%} #}
	      {# 	  <li>{{ kv[0] | e }} = {{ kv[1] | e }}</li> #}
	      {# 	{%- endfor -%} #}
	      {# </ul> #}
	    </div>
	  {%- endfor -%}
	</div>


	<!-- attacks -->
	<div class="attacks">
	  <h1>Attacks</h1>
	  {%- set traitmap = dict() -%}
	  {%- for at in attribs -%}
	    {%- if "id" in at and "name" in at -%}
	      {%- do traitmap.update({ at.id: at }) -%}
	    {%- endif -%}
	    {%- if at.name.startswith("repeating_") -%}
	      {%- set toks = at.name.split("_") -%}
	      {%- set ids = [] -%}
	      {%- for i in toks  -%}
		{%- if i.startswith("-M") -%}
		  {%- do ids.append( i ) -%}
		{%- endif -%}
	      {%- endfor -%}
	      {%- set id = ids[0] -%}
	      {%- set id_index = toks.index( id ) -%}
	      {%- set key = id -%}
	      {%- set value = "_".join( toks[id_index:] ) -%}
	      {%- if key not in traitmap -%}
		{%- do traitmap.update({ key: dict() }) -%}
	      {%- endif -%}
	      {%- do traitmap[key].update({ value : at.current}) -%}
	    {%- endif -%}
	  {%- endfor -%}


	  <!-- find attack traits -->
	  {%- set attack_traits = [] -%}
	  {%- for trait in traitmap -%}
	    {%- for inner in traitmap[trait] -%}
	      {%- if "atkname" in inner -%}
		{%- do attack_traits.append( trait ) -%}
	      {%- endif -%}
	    {%- endfor -%}
	  {%- endfor -%}
	  {%- set namemap = {"atkdmgtype":"","atkbonus":"to-hit = ","atkrange":"range = "} -%}
	  {%- for trait in attack_traits -%}
	    <h3>{{ traitmap[trait][ trait + "_atkname"] | e }}:</h3>
	    <ul>
	      {%- for a in namemap -%}
		{%- if trait + "_" + a in traitmap[trait] -%}
		  <li>{{ namemap[a] | e }}{{ traitmap[trait].get( trait + "_" + a, "") | e}} </li>
		  {%- endif -%}
	      {%- endfor -%}
	    </ul>
	  {%- endfor -%}
	  
	</div>

      </div> <!-- sheet -->
    </div> <!-- whole -->
    
  </body>
  
</html>
